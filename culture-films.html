<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Culture — Films</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Merriweather:wght@300;700&display=swap" rel="stylesheet">

  <style>
    :root{--maxw:760px;--bg:#fff;--text:#111827;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui;line-height:1.7}
    header{background:#8b0000}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px;display:flex;justify-content:space-between}
    h1{margin:0;font-family:Merriweather,serif;font-size:20px;color:#fff}
    nav a{color:#f3f4f6;text-decoration:none;margin-left:12px;font-size:14px}
    main{max-width:var(--maxw);margin:36px auto;padding:0 20px}
    h2{font-family:Merriweather,serif;font-size:18px}
    article{margin-bottom:20px}
    .meta{color:var(--muted);font-size:13px}
    form{margin-top:20px}
    input,textarea{width:100%;padding:10px;margin-bottom:12px;border:1px solid #d1d5db;border-radius:4px}
    button{padding:10px 16px;background:#1f2937;color:#fff;border:none;border-radius:4px;cursor:pointer}
    #proposals-list article{border:1px solid #eee;padding:12px;border-radius:8px}
    pre.debug{display:none;background:#111;color:#0f0;padding:10px;font-size:12px;white-space:pre-wrap}
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <h1>Blog de l'intranquilité</h1>
    <nav>
      <a href="index.html">Accueil</a>
      <a href="culture-films.html">Films</a>
      <a href="culture-livres.html">Livres</a>
      <a href="culture-musiques.html">Musiques</a>
    </nav>
  </div>
</header>

<main>

<h2>Films — Sélection</h2>

<article>
  <h3>Stalker</h3>
  <p class="meta">Andreï Tarkovski — 1979</p>
</article>

<hr>

<h2>Proposer un film</h2>

<form id="proposal-form">
  <input type="hidden" name="section" value="films">
  <input name="pseudo" placeholder="Pseudo" required>
  <input name="title" placeholder="Titre du film" required>
  <textarea name="content" rows="5" placeholder="Commentaire" required></textarea>
  <button>Envoyer</button>
</form>

<p id="result" class="meta"></p>

<hr>

<h2>Propositions récentes</h2>
<div id="proposals-list">Chargement…</div>
<pre id="debug" class="debug"></pre>

</main>

<footer style="text-align:center;color:#777;padding:20px">
  © <span id="year"></span>
</footer>

<!-- dépendances -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<script>
/* ========= CONFIG ========= */
const WORKER_URL = "https://steep-dawn-b94d.ettae634.workers.dev";

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
function debug(t){ $('#debug').style.display = t ? 'block' : 'none'; $('#debug').textContent = t || '' }

/* ========= OPTIMISTIC STORAGE ========= */
const optimistic = []; // propositions locales en attente de confirmation serveur

function sameProposal(a, b){
  if(!a || !b) return false;
  const aC = (a.content||'').trim().slice(0,120);
  const bC = (b.content||'').trim().slice(0,120);
  return a.title === b.title && a.pseudo === b.pseudo && aC === bC;
}

/* ========= RENDER HELPERS ========= */
function sanitizeHtml(html){
  if(window.DOMPurify && typeof DOMPurify.sanitize === 'function'){
    return DOMPurify.sanitize(html);
  }
  // fallback: escape (perd le rendu markdown mais reste sûr)
  return escapeHtml(html);
}

function renderContentFromMarkdown(md){
  try{
    const raw = marked.parse(md || '');
    return sanitizeHtml(raw);
  }catch(e){
    return sanitizeHtml(escapeHtml(md || ''));
  }
}

function createArticleFrom(obj){
  const article = document.createElement('article');
  const h3 = document.createElement('h3');
  h3.innerHTML = escapeHtml(obj.title || 'Sans titre');

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = 'Par ' + (obj.pseudo || 'Anonyme');

  const bodyDiv = document.createElement('div');
  // si on a déjà le HTML (contentHtml), on l'utilise; sinon on génère depuis content
  if(obj.contentHtml){
    bodyDiv.innerHTML = sanitizeHtml(obj.contentHtml);
  } else {
    bodyDiv.innerHTML = renderContentFromMarkdown(obj.content || '');
  }

  article.appendChild(h3);
  article.appendChild(meta);
  article.appendChild(bodyDiv);
  return article;
}

function prependProposal(obj){
  const list = $('#proposals-list');
  if(!list) return;
  if(list.textContent.trim() === 'Aucune proposition.' || list.textContent.trim().startsWith('Erreur')) list.innerHTML = '';
  list.insertAdjacentElement('afterbegin', createArticleFrom(obj));
}

/* ========= FORM ========= */
$('#proposal-form').onsubmit = async e => {
  e.preventDefault();
  $('#result').textContent = 'Envoi…';

  const data = Object.fromEntries(new FormData(e.target).entries());

  try {
    const r = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const j = await r.json();

    if (j.success) {
      $('#result').textContent = '✔ Proposition envoyée';

      // optimistic : marque temporaire + insertion locale
      const temp = Object.assign({}, data, { _tempId: 't'+Date.now() });
      optimistic.unshift(temp);
      prependProposal(temp);

      e.target.reset();

      // re-synchronisation forcée pour checker l'index serveur
      setTimeout(()=>loadProposals('films'), 800);
      setTimeout(()=>loadProposals('films'), 3000);

      // si le worker renvoie l'item exact (j.item), on supprime l'optimistic correspondant
      if(j.item){
        for(let i=0;i<optimistic.length;i++){
          if(sameProposal(optimistic[i], j.item)){
            optimistic.splice(i,1);
            break;
          }
        }
        // et on force un reload pour intégrer la version serveur
        setTimeout(()=>loadProposals('films'), 500);
      }
    } else {
      $('#result').textContent = 'Erreur : ' + (j.error || 'inconnue');
    }
  } catch(err){
    $('#result').textContent = 'Erreur réseau';
    debug(String(err));
  }
};

/* ========= LOAD PROPOSALS ========= */
async function loadProposals(section){
  try{
    const r = await fetch('content/index.json?t=' + Date.now(), { cache: 'no-store' });
    if(!r.ok){
      if(r.status === 404){
        $('#proposals-list').innerHTML = 'Aucune proposition.';
        return;
      }
      throw new Error('status ' + r.status);
    }
    const index = await r.json();

    const items = index.filter(i => i.section === section);
    // récupère le contenu markdown de chaque item (si possible)
    const htmlParts = await Promise.all(items.map(async i=>{
      const path = (i.path || '').replace(/^\/+/, '');
      try{
        const mdText = await (await fetch(path, { cache: 'no-store' })).text();
        const body = mdText.replace(/^---[\s\S]*?---/, '');
        return { title: i.title, pseudo: i.pseudo, contentHtml: marked.parse(body) };
      }catch(e){
        return { title: i.title, pseudo: i.pseudo, contentHtml: '<div class="meta">Erreur lecture contenu</div>' };
      }
    }));

    // Construit l'HTML serveur
    const serverHtml = htmlParts.map(h => {
      return `
      <article>
        <h3>${escapeHtml(h.title)}</h3>
        <div class="meta">Par ${escapeHtml(h.pseudo)}</div>
        ${sanitizeHtml(h.contentHtml)}
      </article>`;
    }).join('');

    // Détecte les optimistics manquantes dans l'index serveur (heuristique)
    const missingOptimistic = optimistic.filter(opt => {
      return !items.some(it =>
        it.title === opt.title &&
        it.pseudo === opt.pseudo &&
        ((it.content||'').trim().slice(0,120) === (opt.content||'').trim().slice(0,120))
      );
    });

    const optimisticHtml = missingOptimistic.map(o => {
      const contentHtml = renderContentFromMarkdown(o.content || '');
      return `<article data-temp="${o._tempId}">
        <h3>${escapeHtml(o.title)}</h3>
        <div class="meta">Par ${escapeHtml(o.pseudo)}</div>
        ${contentHtml}
      </article>`;
    }).join('');

    // Préfixe les optimistic (pour que l'utilisateur voie ses propositions immédiatement)
    const combined = (optimisticHtml ? optimisticHtml : '') + (serverHtml ? serverHtml : '');
    $('#proposals-list').innerHTML = combined || 'Aucune proposition.';

    if(!items.length && !missingOptimistic.length){
      $('#proposals-list').innerHTML = 'Aucune proposition.';
    }
  } catch(e){
    $('#proposals-list').innerHTML = 'Erreur de chargement';
    debug(String(e));
  }
}

/* ========= INIT ========= */
$('#year').textContent = new Date().getFullYear();
loadProposals('films');
</script>

</body>
</html>
