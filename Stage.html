<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Simulation Pyodide — Exemple fonctionnel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, sans-serif; padding:20px; background:#fff; color:#111827; }
    button{background:#8b0000;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    button.secondary{background:#f3f4f6;color:#111;border;border:1px solid #ddd}
    button:disabled{opacity:.5}
    #progress-wrap{width:100%;height:12px;background:#f3f4f6;border-radius:8px;overflow:hidden;margin-top:12px}
    #bar{height:100%;width:0;background:linear-gradient(90deg,#8b0000,#ff6b6b)}
    canvas{width:700px;height:360px;border:1px solid #e5e7eb;margin-top:12px}
    #status{margin-left:12px;color:#6b7280}
    pre { background:#f6f6f6;padding:10px;border-radius:6px; max-height:200px; overflow:auto; }
  </style>
</head>
<body>
  <h2>Simulation Pyodide — Test</h2>

  <div>
    <button id="start">Lancer</button>
    <button id="stop" class="secondary" disabled>Arrêter</button>
    <span id="status">Chargement…</span>
  </div>

  <div id="progress-wrap">
    <div id="bar"></div>
  </div>
  <div id="pct">0%</div>

  <canvas id="simCanvas" width="700" height="360"></canvas>

  <!-- Code Python embarqué -->
  <script id="py-src" type="text/plain">
from js import update, set_progress
import asyncio

running = False

async def run():
    global running
    if running:
        return
    running = True

    points = []
    try:
        for i in range(101):
            if not running:
                break
            x = i / 100
            y = 0.2 + 0.6 * x
            points.append({"x": x, "y": y})
            update(points)
            set_progress(i)   # 0..100
            await asyncio.sleep(0.03)
    finally:
        running = False

def stop():
    global running
    running = False
  </script>

  <!-- Fonctions JS attendues par Python : doivent exister AVANT l'exécution Python -->
  <script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');

    function clearCanvas(){
      ctx.fillStyle = "#f9fafb";
      ctx.fillRect(0,0, canvas.width, canvas.height);
    }
    clearCanvas();

    // Ces fonctions sont appelées depuis Python via `from js import update, set_progress`
    window.update = function(points){
      clearCanvas();
      ctx.strokeStyle = "#8b0000";
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p,i) => {
        const x = p.x * canvas.width;
        const y = canvas.height - p.y * canvas.height;
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();
    };

    window.set_progress = function(pct){
      const v = Math.max(0, Math.min(100, Math.round(pct)));
      document.getElementById('bar').style.width = v + '%';
      document.getElementById('pct').textContent = v + '%';
    };
  </script>

  <!-- Boot Pyodide et wiring -->
  <script>
    // State
    let pyodide = null;
    let ready = false;
    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');
    const statusEl = document.getElementById('status');

    async function initPyodide(){
      try {
        statusEl.textContent = 'Chargement de Pyodide…';
        // charge pyodide (version testée)
        // NB: indexURL doit pointer vers le même répertoire que pyodide.js fournit
        pyodide = await loadPyodide({indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/'});
        // Exécute le code Python embarqué (définit run() et stop())
        const pySrc = document.getElementById('py-src').textContent;
        await pyodide.runPythonAsync(pySrc);
        ready = true;
        statusEl.textContent = 'Prêt';
        console.log('Pyodide prêt');
      } catch (err) {
        console.error('Erreur initPyodide:', err);
        statusEl.textContent = 'Erreur de chargement (voir console)';
      }
    }

    // Botons
    startBtn.addEventListener('click', async () => {
      if (!ready) return;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = 'Lecture en cours';
      try {
        // run() est async -> runPythonAsync renvoie une Promise
        await pyodide.runPythonAsync('run()');
      } catch (err) {
        console.error('Erreur pendant run():', err);
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        statusEl.textContent = 'Prêt';
      }
    });

    stopBtn.addEventListener('click', () => {
      if (!ready) return;
      try {
        pyodide.runPython('stop()'); // stop() est synchrone (set flag)
      } catch (err) {
        console.error('Erreur stop():', err);
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusEl.textContent = 'Arrêté';
    });

    // charge le loader Pyodide (script externe)
    // doit être inclus APRÈS les scripts qui appellent loadPyodide
  </script>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</body>
</html>
