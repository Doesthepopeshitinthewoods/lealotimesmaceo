<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Stage — Simulation</title>

  <!-- Plotly et Pyodide -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    /* Typographie / conteneur */
    :root {
      --muted: #6a737d;
      --line: #e1e4e8;
      --bg: #ffffff;
      --file-bg: #fafbfc;
      --accent: #0366d6;
      --radius: 6px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f6f8fa;
      margin: 24px;
      color: #24292e;
    }
    .panel {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      max-width: 980px;
      margin: 0 auto;
      box-shadow: 0 1px 0 rgba(27,31,35,0.04);
      overflow: hidden;
    }

    /* Entête */
    .panel-header {
      display:flex;
      align-items:center;
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      gap:12px;
    }
    .title {
      font-weight:600;
      font-size:16px;
    }
    .subtitle {
      color:var(--muted);
      font-size:13px;
    }

    /* Liste de fichiers style GitHub */
    .file-list {
      width:100%;
    }
    .file-row {
      display:grid;
      grid-template-columns: 40% 45% 15%;
      align-items:center;
      padding:12px 20px;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: var(--file-bg);
    }
    .file-row:nth-child(odd){ background: #fff; }
    .file-info {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .icon {
      width:20px; height:20px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }
    .fname {
      font-size:14px;
    }
    .commit {
      color:var(--muted);
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .time {
      text-align:right;
      color:var(--muted);
      font-size:13px;
    }
    .file-row:hover { background: #f3f6fb; }

    /* Active file highlight */
    .file-row.active { background: linear-gradient(90deg,#fffefc,#f7fbff); }
    .file-row.active .fname { color:var(--accent); font-weight:600; }

    /* Right panel: controls + plot */
    .right-panel {
      padding:18px 20px;
    }
    .controls {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }
    .btn {
      background: var(--accent);
      color:white;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:disabled { opacity:0.6; cursor:wait; }
    #status { color:var(--muted); font-size:13px; padding-top:6px; }

    #plot {
      width:100%;
      height:480px;
      margin-top:12px;
      border-radius:6px;
      border:1px solid var(--line);
      background:white;
      overflow:hidden;
    }

    /* Responsive */
    @media (max-width:800px){
      .file-row { grid-template-columns: 1fr; gap:8px; padding:10px; }
      .time { text-align:left; }
      .panel { margin:8px; }
    }
  </style>
</head>
<body>
  <div class="panel" role="main">
    <div class="panel-header">
      <div>
        <div class="title">Mon projet — dépôt</div>
        <div class="subtitle">Aperçu · lancer la simulation depuis le site</div>
      </div>
    </div>

    <!-- Mockup liste fichiers -->
    <div class="file-list" aria-hidden="true">
      <div class="file-row">
        <div class="file-info">
          <div class="icon" title="folder">
            <!-- folder SVG -->
            <svg width="18" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.2C2 2.6 2.6 2 3.2 2h3.6l1.2 1.4h7c.6 0 1.2.6 1.2 1.2V10c0 .6-.6 1.2-1.2 1.2H3.2C2.6 11.2 2 10.6 2 10V3.2z" fill="#6a737d"/></svg>
          </div>
          <div class="fname">.github</div>
        </div>
        <div class="commit">Create generate-index.yml</div>
        <div class="time">2 weeks ago</div>
      </div>

      <div class="file-row">
        <div class="file-info">
          <div class="icon" title="folder"><svg width="18" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.2C2 2.6 2.6 2 3.2 2h3.6l1.2 1.4h7c.6 0 1.2.6 1.2 1.2V10c0 .6-.6 1.2-1.2 1.2H3.2C2.6 11.2 2 10.6 2 10V3.2z" fill="#6a737d"/></svg></div>
          <div class="fname">content</div>
        </div>
        <div class="commit">Update content index</div>
        <div class="time">10 hours ago</div>
      </div>

      <!-- simulation.py row -->
      <div class="file-row">
        <div class="file-info">
          <div class="icon" title="file">
            <!-- file SVG -->
            <svg width="14" height="18" viewBox="0 0 14 18" xmlns="http://www.w3.org/2000/svg"><path d="M2 0h6l4 4v14a0 0 0 0 1 0 0H2z" fill="#6a737d"/></svg>
          </div>
          <div class="fname">simulation.py</div>
        </div>
        <div class="commit">Update simulation.py</div>
        <div class="time">32 minutes ago</div>
      </div>

      <!-- Stage.html (active) -->
      <div class="file-row active" id="row-stage">
        <div class="file-info">
          <div class="icon" title="file">
            <svg width="14" height="18" viewBox="0 0 14 18" xmlns="http://www.w3.org/2000/svg"><path d="M2 0h6l4 4v14a0 0 0 0 1 0 0H2z" fill="#0366d6"/></svg>
          </div>
          <div class="fname">Stage.html</div>
        </div>
        <div class="commit">Update Stage.html</div>
        <div class="time">34 minutes ago</div>
      </div>

      <!-- autres fichiers (exemples) -->
      <div class="file-row">
        <div class="file-info">
          <div class="icon" title="file"><svg width="14" height="18" viewBox="0 0 14 18" xmlns="http://www.w3.org/2000/svg"><path d="M2 0h6l4 4v14a0 0 0 0 1 0 0H2z" fill="#6a737d"/></svg></div>
          <div class="fname">index.html</div>
        </div>
        <div class="commit">Update index.html</div>
        <div class="time">53 minutes ago</div>
      </div>
    </div>

    <!-- Right panel: contrôle + affichage -->
    <div class="right-panel">
      <div class="controls" role="region" aria-label="Contrôles simulation">
        <button id="run" class="btn">Lancer la simulation</button>
        <label style="font-size:13px;color:var(--muted)">
          Pas à pas:
          <input id="steps" type="number" value="400" style="width:80px;margin-left:6px;padding:4px;border:1px solid var(--line);border-radius:4px"/>
        </label>
        <label style="font-size:13px;color:var(--muted)">
          dt:
          <input id="dt" type="number" step="0.01" value="0.05" style="width:80px;margin-left:6px;padding:4px;border:1px solid var(--line);border-radius:4px"/>
        </label>
      </div>
      <div id="status">Prêt — Pyodide non chargé.</div>
      <div id="plot" role="img" aria-label="Graphique résultat de la simulation"></div>
    </div>
  </div>

  <script>
    // ---------- PYODIDE + Simulation ----------
    const statusEl = document.getElementById('status');
    const runBtn = document.getElementById('run');
    const stepsInput = document.getElementById('steps');
    const dtInput = document.getElementById('dt');

    let pyodideReady = false;

    async function initPyodide() {
      statusEl.textContent = 'Chargement de Pyodide (cela peut prendre quelques secondes)...';
      window.pyodide = await loadPyodide();
      // si tu utilises numpy/scipy lourds, charger explicitement:
      // await pyodide.loadPackage(['numpy','micropip']);
      pyodideReady = true;
      statusEl.textContent = 'Pyodide chargé — prêt à lancer la simulation.';
    }

    // Charge Pyodide au premier affichage (ou tu peux déclencher à l'ouverture)
    initPyodide();

    // Code python par défaut : remplace ce bloc par le code de ton simulation.py
    // IMPORTANT : ta simulation doit définir une fonction `simulate(steps=..., dt=...)`
    // qui renvoie un dict JSON-serialisable, par ex. {'t':[...], 'x':[...], 'y':[...]}
    const pythonSimulationCode = `
# --- EXEMPLE de simulation (remplace tout ce bloc par le contenu de ton simulation.py) ---
import math
import json

def simulate(steps=200, dt=0.1):
    t = [i*dt for i in range(steps)]
    x = [math.cos(0.1*ti) * (1 + 0.2*math.sin(0.05*ti)) for ti in t]
    y = [math.sin(0.1*ti) * (1 + 0.2*math.cos(0.07*ti)) for ti in t]
    return {'t': t, 'x': x, 'y': y}
# --- FIN exemple ---
`;

    // injecte le code python dans l'interpréteur
    async function loadSimulationCode() {
      if (!pyodideReady) {
        statusEl.textContent = 'Pyodide non encore prêt — chargement en cours...';
        await initPyodide();
      }
      statusEl.textContent = 'Injection du code de simulation...';
      // charge le code python (tu peux remplacer pythonSimulationCode par ton code réel)
      await pyodide.runPythonAsync(pythonSimulationCode);
      statusEl.textContent = 'Code de simulation chargé.';
    }

    // Fonction pour lancer la simulation et récupérer JSON
    async function runSimulation(steps, dt) {
      runBtn.disabled = true;
      statusEl.textContent = 'Exécution de la simulation...';
      try {
        // Appelle simulate et sérialise en JSON côté Python pour faciliter l'échange
        const pyCmd = `
import json
res = simulate(steps=${steps}, dt=${dt})
json.dumps(res)
`;
        const jsonStr = await pyodide.runPythonAsync(pyCmd);
        const data = JSON.parse(jsonStr);
        statusEl.textContent = 'Simulation terminée — affichage...';
        return data;
      } catch (err) {
        statusEl.textContent = 'Erreur lors de la simulation : ' + err;
        console.error(err);
        return null;
      } finally {
        runBtn.disabled = false;
      }
    }

    // Affiche les résultats avec Plotly
    function plotResult(data) {
      if (!data) {
        statusEl.textContent = 'Aucun résultat à afficher.';
        return;
      }
      const t = data.t || [];
      // cherche quelques clés plausibles
      const keys = Object.keys(data).filter(k => k !== 't');
      const traces = keys.map(k => ({ x: t, y: data[k], name: k }));
      Plotly.newPlot('plot', traces, { margin:{t:30}, title:'Résultat de la simulation' });
    }

    // On clique : charge le code (s'il n'est pas encore chargé), exécute et plot
    runBtn.onclick = async () => {
      runBtn.disabled = true;
      if (!pyodideReady) {
        await initPyodide();
      }
      await loadSimulationCode();
      const steps = parseInt(stepsInput.value) || 400;
      const dt = parseFloat(dtInput.value) || 0.05;
      const data = await runSimulation(steps, dt);
      plotResult(data);
      runBtn.disabled = false;
    };

    // Astuce avancée : si tu veux charger le code simulation.py depuis le repo via fetch,
    // il te faut que le fichier soit accessible publiquement (raw.githubusercontent...)
    // et adapter loadSimulationCode() pour faire fetch(...) puis pyodide.runPythonAsync(contents).
  </script>
</body>
</html>
