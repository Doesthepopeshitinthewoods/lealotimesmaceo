<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Stage — Simulation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Merriweather:wght@300;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"></script>

  <style>
    :root{
      --maxw:760px; --bg:#ffffff; --text:#111827; --muted:#6b7280; --accent:#1f2937;
      --brand:#8b0000; --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;line-height:1.7}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    header{background:var(--brand);border-bottom:1px solid #7a0000}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{margin:0;font-family:Merriweather,serif;font-size:20px;font-weight:700;color:#fff}

    nav{display:flex;align-items:center;gap:14px;flex-wrap:nowrap}
    nav a{color:#f3f4f6;font-size:14px}
    nav a.active{text-decoration:underline;font-weight:600}

    main{max-width:var(--maxw);margin:36px auto;padding:0 20px}

    /* Simulation panel */
    .stage-card{border:1px solid var(--line);border-radius:8px;padding:16px;background:#fff}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    .controls label{font-size:14px;color:var(--muted);display:flex;gap:6px;align-items:center}
    input[type="number"], input[type="text"]{padding:8px;border:1px solid #d1d5db;border-radius:6px;font-family:inherit}
    .btn {
      background:var(--brand); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn.secondary { background:#374151; }
    .status{color:var(--muted);font-size:13px;margin-bottom:10px}
    #plot{width:100%;height:420px;border-radius:6px;border:1px solid var(--line);background:#fff;overflow:hidden}

    .code-area{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    textarea#pycode{width:100%;min-height:220px;padding:10px;border:1px solid #e5e7eb;border-radius:6px;font-family:monospace;font-size:13px;white-space:pre;resize:vertical}

    footer{border-top:1px solid var(--line);text-align:center;font-size:14px;color:var(--muted);padding:18px 20px;margin-top:28px}
    @media (max-width:760px){
      .wrap{padding:14px}
      .controls{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>Blog de l'intranquilité</h1>

    <div style="display:flex;align-items:center;gap:16px">
      <nav aria-label="Navigation principale">
        <a href="index.html">Accueil</a>
        <a href="articles.html">Articles</a>
        <a href="projets-libres-pensees.html">Projets</a>
      </nav>
    </div>
  </div>
</header>

<main>
  <section class="stage-card" aria-labelledby="stage-title">
    <h2 id="stage-title" style="margin:0 0 8px;font-family:Merriweather,serif">Stage — Exécuter la simulation</h2>

    <div class="controls" role="region" aria-label="Contrôles de la simulation">
      <button id="run" class="btn">Lancer la simulation</button>
      <button id="load-default" class="btn secondary">Charger l'exemple</button>

      <label>steps:
        <input id="steps" type="number" value="400" min="1" style="width:110px">
      </label>

      <label>dt:
        <input id="dt" type="number" step="0.01" value="0.05" style="width:110px">
      </label>

      <label style="flex:1;min-width:180px">Charger depuis raw GitHub:
        <input id="rawurl" type="text" placeholder="https://raw.githubusercontent.com/..." style="width:100%">
      </label>
      <button id="load-raw" class="btn secondary">Charger URL</button>
    </div>

    <div class="status" id="status">Pyodide non chargé — le chargement prend quelques secondes la première fois.</div>

    <div class="code-area" aria-hidden="false">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
        <strong>Code Python (colle ton <code>simulation.py</code> ici)</strong>
        <small style="color:var(--muted)">La fonction attendue : <code>simulate(steps=..., dt=...)</code> → retourne dict sérialisable (clé <code>t</code> requise).</small>
      </div>
      <textarea id="pycode">
# Exemple minimal — remplace par ton simulation.py
import math
def simulate(steps=200, dt=0.1):
    t = [i*dt for i in range(steps)]
    x = [math.cos(0.12*ti) * (1 + 0.12*math.sin(0.05*ti)) for ti in t]
    y = [math.sin(0.12*ti) * (1 + 0.10*math.cos(0.07*ti)) for ti in t]
    return {'t': t, 'x': x, 'y': y}
      </textarea>
    </div>

    <div id="plot" aria-label="Graphique de la simulation"></div>
  </section>
</main>

<footer>
  © <span id="year"></span> — Blog personnel
</footer>

<script>
  // affiche l'année
  document.getElementById('year').textContent = new Date().getFullYear();

  // éléments DOM
  const statusEl = document.getElementById('status');
  const runBtn = document.getElementById('run');
  const loadDefaultBtn = document.getElementById('load-default');
  const loadRawBtn = document.getElementById('load-raw');
  const rawUrlInput = document.getElementById('rawurl');
  const pycodeEl = document.getElementById('pycode');
  const stepsInput = document.getElementById('steps');
  const dtInput = document.getElementById('dt');

  let pyodide = null;
  let pyReady = false;

  // charge Pyodide si nécessaire
  async function ensurePyodide(){
    if (pyReady) return;
    statusEl.textContent = 'Chargement de Pyodide (quelques secondes)...';
    try {
      pyodide = await loadPyodide();
      // si tu utilises numpy ou scipy, décommente la ligne suivante :
      // await pyodide.loadPackage(['numpy']);
      pyReady = true;
      statusEl.textContent = 'Pyodide chargé.';
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Erreur chargement Pyodide : ' + err;
      throw err;
    }
  }

  // injecte le code Python dans l'interpréteur
  async function injectCode(codeText){
    await ensurePyodide();
    statusEl.textContent = 'Injection du code Python...';
    try {
      // runPythonAsync permet d'exécuter le code et de définir simulate(...)
      await pyodide.runPythonAsync(codeText);
      statusEl.textContent = 'Code chargé — prêt.';
      return true;
    } catch (err) {
      console.error('Erreur injection code:', err);
      statusEl.textContent = 'Erreur lors de l\'injection du code : ' + (err.message || err);
      return false;
    }
  }

  // charger depuis raw GitHub (raw.githubusercontent.com)
  loadRawBtn.addEventListener('click', async () => {
    const url = rawUrlInput.value.trim();
    if (!url) { statusEl.textContent = 'Entrez une URL raw GitHub valide.'; return; }
    try {
      statusEl.textContent = 'Téléchargement du fichier depuis l\'URL...';
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const txt = await r.text();
      pycodeEl.value = txt;
      const ok = await injectCode(txt);
      if (ok) statusEl.textContent = 'Fichier chargé depuis GitHub — prêt à exécuter.';
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Impossible de charger le fichier : ' + e;
    }
  });

  // restaurer l'exemple
  loadDefaultBtn.addEventListener('click', () => {
    pycodeEl.value = `# Exemple minimal — remplace par ton simulation.py
import math
def simulate(steps=200, dt=0.1):
    t = [i*dt for i in range(steps)]
    x = [math.cos(0.12*ti) * (1 + 0.12*math.sin(0.05*ti)) for ti in t]
    y = [math.sin(0.12*ti) * (1 + 0.10*math.cos(0.07*ti)) for ti in t]
    return {'t': t, 'x': x, 'y': y}
`;
    statusEl.textContent = 'Exemple restauré dans l\'éditeur.';
  });

  // exécution : on injecte toujours le contenu actuel du textarea (pratique pour éditer)
  runBtn.addEventListener('click', async () => {
    runBtn.disabled = true;
    statusEl.textContent = 'Préparation...';
    try {
      const codeText = pycodeEl.value;
      const ok = await injectCode(codeText);
      if (!ok) { runBtn.disabled = false; return; }

      const steps = parseInt(stepsInput.value) || 200;
      const dt = parseFloat(dtInput.value) || 0.1;

      statusEl.textContent = `Exécution de simulate(steps=${steps}, dt=${dt})...`;

      // Sérialise le résultat côté Python en JSON pour éviter les PyProxy
      const pyCmd = `
import json
res = simulate(steps=${steps}, dt=${dt})
json.dumps(res)
`;
      const jsonStr = await pyodide.runPythonAsync(pyCmd);
      const data = JSON.parse(jsonStr);

      statusEl.textContent = 'Simulation terminée — affichage...';
      plotData(data);
    } catch (err) {
      console.error('Erreur pendant la simulation:', err);
      statusEl.textContent = 'Erreur pendant la simulation : ' + (err.message || err);
    } finally {
      runBtn.disabled = false;
    }
  });

  // trace Plotly
  function plotData(data){
    if (!data || !data.t) {
      statusEl.textContent = 'Données invalides : la clé "t" est requise dans le dict retourné.';
      return;
    }
    const t = data.t;
    const traces = [];
    Object.keys(data).forEach(k => {
      if (k === 't') return;
      // assure que les séries sont des arrays JS
      traces.push({ x: t, y: data[k], name: k });
    });
    const layout = { margin:{t:36}, title: 'Résultat de la simulation', height:420 };
    Plotly.newPlot('plot', traces, layout, {responsive:true});
  }

  // Option : précharger Pyodide en fond au chargement de la page (décommente si souhaité)
  // window.addEventListener('load', () => { ensurePyodide().catch(()=>{}); });

</script>

</body>
</html>


