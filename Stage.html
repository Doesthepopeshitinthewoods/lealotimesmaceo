<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Articles — Blog de l'intranquilité</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Merriweather:wght@300;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"></script>

  <style>
    :root{
      --maxw:760px; --bg:#ffffff; --text:#111827; --muted:#6b7280; --accent:#1f2937;
      --brand:#8b0000;
      --pad:18px; --gap:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;line-height:1.7}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    header{background:var(--brand);border-bottom:1px solid #7a0000}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:var(--pad);display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{margin:0;font-family:Merriweather,serif;font-size:20px;font-weight:700;color:#fff}

    nav{display:flex;align-items:center;gap:14px;flex-wrap:wrap;flex:1}
    nav a{color:#f3f4f6;font-size:14px}
    nav a.active{text-decoration:underline;font-weight:600}

    .menu-projets,.menu-culture{position:relative;display:flex;align-items:center}
    .projets-dropdown,.culture-dropdown{
      display:none; position:absolute; top:100%; left:0; background:#fff; border:1px solid #e5e7eb; border-radius:6px; min-width:160px; z-index:10;
    }
    .projets-dropdown a,.culture-dropdown a{display:block;padding:8px 12px;color:var(--text)}
    .menu-projets:hover .projets-dropdown,.menu-culture:hover .culture-dropdown{display:block}

    .langs{display:flex;gap:6px;align-items:center}
    .langs img.flag{width:22px;height:14px;border-radius:2px;border:1px solid transparent;cursor:pointer}

    main{max-width:var(--maxw);margin:36px auto;padding:0 20px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;flex-wrap:wrap}
    .search{flex:1;max-width:360px}
    input[type="search"], input[type="number"]{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-family:inherit}

    .card{border:1px solid #e6e6e9;border-radius:8px;padding:14px;background:#fff}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    input[type="number"]{padding:8px;border:1px solid #ddd;border-radius:6px}
    .btn{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn:focus{outline:3px solid rgba(255,255,255,0.12)}
    #plot{width:100%;height:60vh;min-height:360px;margin-top:8px}
    .progress-wrap{height:14px;background:#fff;border:2px solid #ddd;border-radius:4px;overflow:hidden;margin-top:8px}
    .progress-bar{height:100%;width:0;background:#1f77b4}
    .controls-right{margin-left:auto;display:flex;align-items:center;gap:8px}

    /* Loader overlay */
    #loaderOverlay{
      display:none;
      position:fixed; left:0; top:0; right:0; bottom:0;
      background: rgba(0,0,0,0.45);
      z-index:9999;
      align-items:center; justify-content:center;
    }
    #loaderBox{
      width:520px; max-width:90%; background:#fff; border-radius:8px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.3);
      display:flex; flex-direction:column; gap:12px; align-items:stretch;
    }
    #loaderTitle{font-weight:600; font-family:Merriweather,serif}
    #loaderMsg{color:#444; font-size:14px}
    #loaderProgressWrap{height:12px;background:#f3f4f6;border-radius:6px;overflow:hidden;border:1px solid #e5e7eb}
    #loaderProgress{height:100%; width:0%; background: linear-gradient(90deg,#6a2c70,#f27059,#f9d423); transition:width 220ms linear}

    /* spinner */
    .spinner { width:28px;height:28px;border-radius:50%;border:4px solid #eee;border-top-color:var(--brand); animation:spin 1s linear infinite; margin-left:auto;}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:840px){
      :root{--maxw:720px}
      #plot{height:50vh}
    }

    @media (max-width:640px){
      .wrap{padding:14px}
      .wrap{align-items:flex-start}
      nav{order:2; width:100%}
      .langs{order:3}
      main{margin:18px auto}
      #plot{height:48vh}
      #loaderBox{padding:12px}
      .controls{gap:8px}
      .btn.full-mobile{width:100%}
      .controls-right{width:100%;justify-content:flex-end}
    }

    /* focus for accessibility */
    a:focus, button:focus, input:focus { outline:3px solid rgba(59,130,246,0.18); outline-offset:2px }
  </style>

  <script>
  window.MathJax = {
  tex: {
  inlineMath: [['\\(','\\)'], ['$', '$']],
  displayMath: [['\\[','\\]'], ['$$','$$']]
  }
  };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Blog de l'intranquilité</h1>
    <div style="display:flex;align-items:center;gap:16px">
      <nav aria-label="Navigation principale">
        <a href="index.html">Accueil</a>
        <a href="articles.html" id="nav-articles">Articles</a>
        <div class="menu-projets">
          <a href="projets-libres-pensees.html">Projets ▾</a>
          <div class="projets-dropdown" role="menu" aria-label="Projets">
            <a href="projets-libres-pensees.html">Libres Pensées</a>
            <a href="#">Bref</a>
          </div>
        </div>
        <div class="menu-culture">
          <a href="#" class="culture-btn">Culture ▾</a>
          <div class="culture-dropdown" role="menu" aria-label="Culture">
            <a href="culture-films.html">Films</a>
            <a href="culture-livres.html">Livres</a>
            <a href="culture-musiques.html">Musiques</a>
          </div>
        </div>
      </nav>

      <div class="langs" role="navigation" aria-label="Choix de la langue">
        <img src="https://flagcdn.com/w20/fr.png" data-lang="fr" alt="Français" class="flag" tabindex="0">
        <img src="https://flagcdn.com/w20/gb.png" data-lang="en" alt="English" class="flag" tabindex="0">
        <img src="https://flagcdn.com/w20/pt.png" data-lang="pt" alt="Português" class="flag" tabindex="0">
      </div>
    </div>
  </div>
</header>

<main>
  <div class="toolbar">
    <h2 style="margin:0;font-family:Merriweather,serif">Simulation — jetlets 0</h2>
  </div>

  <section class="card">
    <div class="controls">
      <button id="run" class="btn full-mobile">Lancer la simulation</button>

      <label>n_images:
        <input id="n_image" type="number" value="100" min="5" style="width:80px">
      </label>

      <label>grid (nx):
        <input id="grid_nx" type="number" value="100" min="8" style="width:70px">
      </label>

      <label>grid (ny):
        <input id="grid_ny" type="number" value="100" min="8" style="width:70px">
      </label>

      <label>T_final:
        <input id="Tfinal" type="number" value="100" step="1" style="width:80px">
      </label>

      <label title="Si décoché, pas de calcul du champ (beaucoup plus rapide)" style="display:flex;align-items:center;gap:6px">
        <input id="compute_field" type="checkbox" checked style="width:16px;height:16px"> Calculer le champ
      </label>

      <div class="controls-right">
        <div style="text-align:right"><span id="status" class="small" aria-live="polite"></span></div>
      </div>
    </div>

    <div id="plot" aria-label="Zone de visualisation"></div>

    <div class="progress-wrap"><div id="progressBar" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div></div>

    <div style="display:flex;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div class="small">Temps : <span id="timeDisplay">—</span> s</div>
      <input id="timeSlider" type="range" min="0" max="0" value="0" step="1" style="flex:1">
      <label style="display:flex;align-items:center;gap:6px">Vitesse:
        <input id="speedRange" type="range" min="10" max="500" value="100" style="width:160px">
      </label>
      <button id="play" class="btn">▶ Play</button>
    </div>

  </section>


  <header>
<section class="box">
<h2>3. Inversion : du momentum au champ de vitesse — noyau \(K\)</h2>
<p>Si \(\mathcal{A}\) est inversible, on a :</p>
<p style="text-align:center;">\[ u = \mathcal{A}^{-1} m = K * m, \]</p>
<p>où \(K\) est la fonction de Green de \(\mathcal{A}\). En Fourier : \(\widehat{K}(k)=\widehat{\mathcal{A}}(k)^{-1}\), ce qui montre explicitement que \(s\) intervient dans la décroissance spectrale de \(K\).</p>


<h3>3.2 Forme matricielle utilisée en 2D</h3>
<p>Pour des opérateurs choisis, Cotter et al. donnent une expression explicite :</p>
<p style="text-align:center;">\[ K(r) = A(\alpha(r) I + \beta(r) r\otimes r), \]</p>
<p>avec \(r=x-q\) et des scalaires \(A,\alpha(r),\beta(r)\) dépendant de \(|r|\) et des paramètres de régularisation. Cette décomposition (isotrope + projecteur radial) est commode pour écrire les interactions entre particules.</p>
</section>


<section>
<h2>4. Représentation particulaire : ansatz en jets — notation détaillée</h2>
<p>On cherche une approximation du momentum par une combinaison finie de distributions localisées. L'ansatz général (développement en jets) s'écrit :</p>
<p style="text-align:center;">\[ m(x,t) \approx \sum_{\alpha=1}^N \sum_{|\gamma|\le K} M^\gamma_\alpha(t) \,\partial^\gamma \delta(x-q_\alpha(t)). \]</p>


<h3>Interprétation détaillée de la notation</h3>
<ul>
<li>\(\alpha\) : index de la particule (\(1\dots N\)).</li>
<li>\(q_\alpha(t)\in\mathbb{R}^d\) : position temporelle de la particule \(\alpha\).</li>
<li>Multi‑indice \(\gamma=(\gamma_1,\dots,\gamma_d)\in\mathbb{N}^d\) : \(|\gamma|=\gamma_1+\dots+\gamma_d\) est l'ordre total de dérivation. Par exemple \(|\gamma|=1\) correspond aux dérivées partielles premières \(\partial_{x_j}\).</li>
<li>\(\partial^\gamma \delta(x-q_\alpha)\) : dérivée distribuée de la Dirac de multi‑indice \(\gamma\). Ce terme encode la structure locale du momentum autour de \(q_\alpha\) (dipôle, quadrupôle, ... selon l'ordre).</li>
<li>Coefficient \(M^\gamma_\alpha(t)\) : tenseur (ou composante de tenseur) associé à la particule et à l'ordre \(|\gamma|\). Par exemple :</li>
<ul>
<li>si \(|\gamma|=0\) : \(M^0_\alpha = p_\alpha\) est le vecteur momentum (0‑jet).</li>
<li>si \(|\gamma|=1\) : \(M^{(1,0,\dots)}_\alpha, M^{(0,1,\dots)}_\alpha\) forment un vecteur/tenseur de rang supérieur décrivant la pente locale du momentum.</li>
</ul>
<li>Troncature : on choisit un ordre maximal \(K\). L'ordre 0 (0‑jetlets) correspond à ne retenir que \(|\gamma|=0\), i.e. \(m(x)=\sum_\alpha p_\alpha\delta(x-q_\alpha)\).</li>
</ul>


<h3>Pourquoi cette notation ?</h3>
<p>Le développement en jets est la version locale d'un développement de Taylor appliqué à la distribution de momentum autour de chaque particule. Il permet une hiérarchie de modèles : augmenter \(K\) améliore l'approximation locale (capturer l'anisotropie, le cisaillement), mais augmente la complexité (degrés de liberté supplémentaires, tenseurs). L'ordre 0 est le premier niveau — simple, interprétable et souvent suffisant pour capter l'essentiel du transport et des interactions non‑locales via le noyau \(K\).</p>
</section>


<section class="box">
<h2>5. Champ de vitesse et Hamiltonien particulaire (ordre 0)</h2>
<p>En ordre 0 l'ansatz devient :</p>
<p style="text-align:center;">\[ m(x,t)=\sum_{\alpha=1}^N p_\alpha(t)\,\delta(x-q_\alpha(t)), \qquad u(x,t)=\sum_\alpha K(x-q_\alpha) p_\alpha. \]</p>


<p>L'énergie particulaire et les équations Hamiltoniennes se déduisent comme précédemment (voir annexe pour la dérivation détaillée de \(\partial_{q_\alpha}H\)).</p>
</section>


<section>
<h2>6. Justification du choix d'ordre 0</h2>
<p>On choisit l'ordre 0 parce qu'il combine :</p>
<ul>
<li>simplicité et faible coût numérique,</li>
<li>préservation d'une structure hamiltonienne explicite,</li>
<li>capacité à reproduire de façon qualitative la dynamique d'interaction non locale via \(K\).</li>
</ul>
<p>Limite : si le champ présente des gradients locaux importants, il peut être nécessaire d'augmenter l'ordre ou d'ajouter des particules.</p>
</section>


<section>
<h2>7. Introduction du bruit : formalisation LU</h2>
<p>Le bruit modélise les petites échelles non résolues. On écrit la composante stochastique de transport :</p>
<p style="text-align:center;">\[ dX_t = u(X_t,t)\,dt + \sigma(X_t,t)\circ dW_t, \quad \sigma(x)\circ dW_t \approx \sum_{k=1}^K \varphi_k(x)\circ d\beta^k_t. \]</p>
<p>La covariance locale est \(a(x)=\sum_k \varphi_k(x)\varphi_k(x)^T\) et génère, au passage Itô↔Stratonovich, des termes de dérive moyenne et de diffusion effective.</p>
</section>


<section>
<h2>8. Projection du bruit sur les degrés de liberté particulaires</h2>
<p>Projection standard :</p>
<p style="text-align:center;">\[ d q_\alpha = u(q_\alpha)\,dt + \sum_k \varphi_k(q_\alpha)\circ d\beta^k_t, \]</p>
<p style="text-align:center;">\[ d p_\alpha = - (\nabla u(q_\alpha))^T p_\alpha\,dt - \sum_k (\nabla\varphi_k(q_\alpha))^T p_\alpha \circ d\beta^k_t. \]</p>
<p>Ainsi les particules subissent à la fois un transport aléatoire (positions) et une modulation du momentum (effet du gradient spatial du bruit).</p>
</section>


<section class="box">
<h2>9. Effets macroscopiques : Itô–Stratonovich, dérive et diffusion</h2>
<p>En moyennant sur le bruit on obtient des termes effectifs :</p>
<ul>
<li>Dérive d'Itô–Stokes : \(u_s=\tfrac12\nabla\cdot a(x)\).</li>
<li>Diffusion inhomogène : contribution de la forme \(-\tfrac12\nabla\cdot(a\nabla u)\).</li>
</ul>
<p>Ces termes montrent comment un bruit microscopique (modes \(\varphi_k\)) se traduit en une modification déterministe moyenne du comportement macroscopique.</p>
</section>


<section>
<h2>Annexe — rappel sur les multi-indices et dérivées de distributions</h2>
<p>Pour rappel : si \(\gamma=(\gamma_1,\dots,\gamma_d)\) alors</p>
<p style="text-align:center;">\[ \partial^\gamma = \partial_{x_1}^{\gamma_1}\cdots\partial_{x_d}^{\gamma_d}, \qquad |\gamma|=\sum_j \gamma_j. \]</p>
<p>La dérivée d'une distribution agit par dualité sur les fonctions test : \(\langle \partial^\gamma\delta(\cdot-q), \phi\rangle = (-1)^{|\gamma|} \partial^\gamma\phi(q)\).</p>
</section>


<footer>
<p class="small">Souhaites-tu que je remplace le document original dans le canevas par cette version (je peux le faire), ou préfères-tu que je génère un PDF/LaTeX propre à partir de ce HTML ?</p>
</footer>
</main>

<footer style="border-top:1px solid #e5e7eb;text-align:center;font-size:14px;color:var(--muted);padding:18px 20px;margin-top:18px">
  © <span id="year"></span> — Blog personnel
</footer>

<!-- Loader overlay shown during Pyodide load & injection -->
<div id="loaderOverlay" aria-hidden="true">
  <div id="loaderBox" role="status" aria-live="polite">
    <div style="display:flex;align-items:center;gap:12px">
      <div id="loaderTitle">Chargement du moteur Python (Pyodide)</div>
      <div class="spinner" aria-hidden="true"></div>
    </div>
    <div id="loaderMsg">Préparation...</div>
    <div id="loaderProgressWrap"><div id="loaderProgress" style="width:4%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:13px;color:#666">
      <div id="loaderHint">Ne pas fermer cette fenêtre</div>
      <div id="loaderPct">0%</div>
    </div>
  </div>
</div>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // small UI style constants
  const STYLE = {
    contourLineWidth: 1.8,
    backgroundQuiverWidth: 1.6,
    backgroundQuiverHeadSize: 5,
    particleArrowWidth: 2.8,
    particleArrowHeadSize: 9,
    particleMarkerSize: 8
  };

  // DOM
  const runBtn = document.getElementById('run');
  const statusEl = document.getElementById('status');
  const nImageInput = document.getElementById('n_image');
  const gridNxInput = document.getElementById('grid_nx');
  const gridNyInput = document.getElementById('grid_ny');
  const TfinalInput = document.getElementById('Tfinal');
  const computeFieldCheckbox = document.getElementById('compute_field');
  const plotDiv = document.getElementById('plot');
  const timeSlider = document.getElementById('timeSlider');
  const timeDisplay = document.getElementById('timeDisplay');
  const playBtn = document.getElementById('play');
  const progressBar = document.getElementById('progressBar');
  const speedRange = document.getElementById('speedRange');

  const loaderOverlay = document.getElementById('loaderOverlay');
  const loaderMsg = document.getElementById('loaderMsg');
  const loaderProgress = document.getElementById('loaderProgress');
  const loaderPct = document.getElementById('loaderPct');

  let pyodide = null, pyReady=false;
  let simData = null, playInterval = null, playSpeedMs = 100;
  let loaderInterval = null;

  function showLoader(titleText, initialMsg){
    loaderOverlay.style.display = 'flex';
    loaderOverlay.setAttribute('aria-hidden','false');
    document.getElementById('loaderTitle').textContent = titleText || 'Chargement';
    loaderMsg.textContent = initialMsg || '';
    loaderProgress.style.width = '4%';
    loaderPct.textContent = '0%';
    // animate pseudo progress: linear slow until we call done
    let pct = 4;
    clearInterval(loaderInterval);
    loaderInterval = setInterval(()=>{
      // increment slowly; slow near 95%
      if(pct < 92){
        pct += Math.random() * 6; // variable steps
      } else if(pct < 98){
        pct += Math.random() * 1.6;
      } else {
        pct += 0.0;
      }
      pct = Math.min(pct, 98);
      loaderProgress.style.width = pct.toFixed(1) + '%';
      loaderPct.textContent = Math.round(pct) + '%';
    }, 220);
  }
  function updateLoaderMessage(msg){
    loaderMsg.textContent = msg || '';
  }
  function setLoaderProgress(pct, msg){
    clearInterval(loaderInterval);
    const p = Math.max(0, Math.min(100, pct));
    loaderProgress.style.width = p + '%';
    loaderPct.textContent = Math.round(p) + '%';
    if(msg) loaderMsg.textContent = msg;
  }
  function hideLoader(){
    clearInterval(loaderInterval);
    loaderInterval = null;
    loaderProgress.style.width = '100%';
    loaderPct.textContent = '100%';
    setTimeout(()=>{
      loaderOverlay.style.display = 'none';
      loaderOverlay.setAttribute('aria-hidden','true');
    }, 200);
  }

  function flatToXY(flat){
    const xs=[], ys=[];
    for(let i=0;i<flat.length;i+=2){ xs.push(flat[i]); ys.push(flat[i+1]); }
    return {xs, ys};
  }

  async function ensurePyodide(){
    if(pyReady) return;
    showLoader('Chargement du moteur Python (Pyodide)', 'Téléchargement en cours...');
    try{
      const loadStart = performance.now();
      pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.0/full/"});
      setLoaderProgress(45, 'Initialisation de l\'environnement Python...');
      try {
        await pyodide.loadPackage(['numpy']);
        setLoaderProgress(75, 'numpy prêt.');
      } catch(e){
        updateLoaderMessage('Installation de numpy via micropip (fallback)...');
        try {
          await pyodide.loadPackage(['micropip']);
          await pyodide.runPythonAsync(`\nimport micropip\nawait micropip.install("numpy")\n`);
          setLoaderProgress(85, 'numpy installé via micropip.');
        } catch(err){
          console.error('Impossible d\'installer numpy via micropip:', err);
          setLoaderProgress(10, 'Erreur installation numpy');
          throw err;
        }
      }
      setLoaderProgress(90, 'Prêt.');
      pyReady = true;
    } catch (err){
      console.error('ensurePyodide error', err);
      hideLoader();
      throw err;
    }
  }

  async function fetchAndInjectSimulation(){
    showLoader('Injection du code Python', 'Récupération du fichier simulation.py ...');
    try {
      const r = await fetch('simulation.py', {cache:'no-store'});
      if(!r.ok){ setLoaderProgress(5, 'Erreur téléchargement'); throw new Error('fetch error ' + r.status); }
      setLoaderProgress(40, 'Lecture du fichier...');
      const txt = await r.text();
      setLoaderProgress(55, 'Injection du code...');
      await pyodide.runPythonAsync(txt);
      setLoaderProgress(95, 'Code injecté.');
      await new Promise(res => setTimeout(res, 200));
      hideLoader();
    } catch(err){
      console.error('Erreur fetch/inject', err);
      hideLoader();
      throw err;
    }
  }

  async function callSim(n_image, grid_nx, grid_ny, Tfinal, compute_field){
    statusEl.textContent = 'Exécution simulate(...) (peut être long)...';
    progressBar.style.width = '2%';
    const dt = Tfinal / Math.max(1, (n_image - 1));
    const pyCall = `\nimport json\nres = simulate(steps=None, dt=${dt}, n_image_local=${n_image}, grid_nx_field=${grid_nx}, grid_ny_field=${grid_ny}, grid_extent_local=5.0, compute_field=${compute_field})\njson.dumps(res)\n`;
    progressBar.style.width = '12%';
    const jsonStr = await pyodide.runPythonAsync(pyCall);
    progressBar.style.width = '100%';
    return JSON.parse(jsonStr);
  }

  // Plot initialization and update functions (unchanged logic)
  function initPlot(data){
    simData = data;
    const traces = [];
    const hasField = Array.isArray(data.Ux_fields) && data.Ux_fields.length>0 && data.Ux_fields[0].length>0;

    if(hasField){
      const grid_nx = data.grid_nx, grid_ny = data.grid_ny;
      const z = [];
      for(let j=0;j<grid_ny;j++){
        const row=[];
        for(let i=0;i<grid_nx;i++){
          const idx = j*grid_nx + i;
          row.push(Math.hypot(data.Ux_fields[0][idx], data.Uy_fields[0][idx]));
        }
        z.push(row);
      }
      traces.push({
        z:z, x:data.grid_x, y:data.grid_y, type:'contour',
        colorscale:'Plasma',
        contours:{coloring:'heatmap'},
        showscale:true,
        colorbar:{title:'|u|',thickness:20,outlinewidth:0,ticklen:6}
      });

      const stride = Math.max(1, Math.floor(grid_nx / 20));
      const qx=[], qy=[], quvx=[], quvy=[];
      for(let j=0;j<grid_ny;j+=stride){
        for(let i=0;i<grid_nx;i+=stride){
          const idx=j*grid_nx + i;
          qx.push(data.grid_x[i]); qy.push(data.grid_y[j]);
          quvx.push(data.Ux_fields[0][idx]); quvy.push(data.Uy_fields[0][idx]);
        }
      }
      const ax=[], ay=[], headx=[], heady=[];
      const scale = 0.25 * Math.max(Math.abs(data.grid_x[1]-data.grid_x[0]), Math.abs(data.grid_y[1]-data.grid_y[0]));
      for(let k=0;k<qx.length;k++){
        const x0=qx[k], y0=qy[k];
        const x1=x0 + scale*quvx[k], y1=y0 + scale*quvy[k];
        ax.push(x0); ax.push(x1); ax.push(null);
        ay.push(y0); ay.push(y1); ay.push(null);
        headx.push(x1); heady.push(y1);
      }
      traces.push({ x:ax, y:ay, mode:'lines', line:{color:'rgb(45,32,110)', width:STYLE.backgroundQuiverWidth}, hoverinfo:'none', showlegend:false });
      traces.push({ x:headx, y:heady, mode:'markers', marker:{size:STYLE.backgroundQuiverHeadSize, symbol:'triangle-up', color:'rgb(45,32,110)'}, hoverinfo:'none', showlegend:false });
    }

    const frame0 = data.qs_hist[0];
    const {xs:px0, ys:py0} = flatToXY(frame0);
    traces.push({ x: px0, y: py0, mode:'markers', marker:{size:STYLE.particleMarkerSize, color:'red'}, name:'particles', hoverinfo:'text' });

    const u0 = data.u_selfs[0];
    const axp=[], ayp=[], hxp=[], hyp=[];
    for(let i=0;i<frame0.length;i+=2){
      const x0=frame0[i], y0=frame0[i+1];
      const vx=u0[i], vy=u0[i+1];
      const x1 = x0 + 0.6 * vx, y1 = y0 + 0.6 * vy;
      axp.push(x0); axp.push(x1); axp.push(null);
      ayp.push(y0); ayp.push(y1); ayp.push(null);
      hxp.push(x1); hyp.push(y1);
    }
    traces.push({ x:axp, y:ayp, mode:'lines', line:{color:'red', width: STYLE.particleArrowWidth}, hoverinfo:'none', showlegend:false });
    traces.push({ x:hxp, y:hyp, mode:'markers', marker:{size: STYLE.particleArrowHeadSize, symbol:'triangle-up', color:'red'}, hoverinfo:'none', showlegend:false });

    const layout = {
      title: ' Particules soumisent au champ 0 jetlet.',
      margin:{t:40,l:60,r:80,b:60},
      xaxis:{title:'x'}, yaxis:{title:'y',scaleanchor:'x',scaleratio:1}
    };

    Plotly.newPlot(plotDiv, traces, layout, {responsive:true});
    timeSlider.min = 0;
    timeSlider.max = Math.max(0, data.t.length - 1);
    timeSlider.value = 0;
    timeDisplay.textContent = data.t[0].toFixed(2);
  }

  function updateFrame(idx){
    if(!simData) return;
    const data = simData;
    const frame = data.qs_hist[idx];
    const u = data.u_selfs[idx];
    const hasField = Array.isArray(data.Ux_fields) && data.Ux_fields.length>0 && data.Ux_fields[0].length>0;

    if(hasField){
      const grid_nx = data.grid_nx, grid_ny = data.grid_ny;
      const Ux = data.Ux_fields[idx], Uy = data.Uy_fields[idx];
      const z = [];
      for(let j=0;j<grid_ny;j++){
        const row=[];
        for(let i=0;i<grid_nx;i++){
          const id=j*grid_nx + i;
          row.push(Math.hypot(Ux[id], Uy[id]));
        }
        z.push(row);
      }
      Plotly.restyle(plotDiv, {'z':[z]}, [0]);

      const stride = Math.max(1, Math.floor(grid_nx / 20));
      const ax=[], ay=[], hx=[], hy=[];
      const scale = 0.25 * Math.max(Math.abs(data.grid_x[1]-data.grid_x[0]), Math.abs(data.grid_y[1]-data.grid_y[0]));
      for(let j=0;j<grid_ny;j+=stride){
        for(let i=0;i<grid_nx;i+=stride){
          const id=j*grid_nx + i;
          const x0=data.grid_x[i], y0=data.grid_y[j];
          const x1=x0 + scale * Ux[id], y1=y0 + scale * Uy[id];
          ax.push(x0); ax.push(x1); ax.push(null);
          ay.push(y0); ay.push(y1); ay.push(null);
          hx.push(x1); hy.push(y1);
        }
      }
      Plotly.restyle(plotDiv, {'x':[ax],'y':[ay]}, [1]);
      Plotly.restyle(plotDiv, {'x':[hx],'y':[hy]}, [2]);
    }

    const has = hasField ? 3 : 0;
    const markerIdx = has;
    const arrowLinesIdx = has + 1;
    const arrowHeadsIdx = has + 2;

    const xs = [], ys = [];
    for(let i=0;i<frame.length;i+=2){ xs.push(frame[i]); ys.push(frame[i+1]); }
    Plotly.restyle(plotDiv, {'x':[xs], 'y':[ys]}, [markerIdx]);

    const axp=[], ayp=[], hxp=[], hyp=[];
    for(let i=0;i<frame.length;i+=2){
      const x0=frame[i], y0=frame[i+1];
      const vx=u[i], vy=u[i+1];
      const x1 = x0 + 0.6 * vx, y1 = y0 + 0.6 * vy;
      axp.push(x0); axp.push(x1); axp.push(null);
      ayp.push(y0); ayp.push(y1); ayp.push(null);
      hxp.push(x1); hyp.push(y1);
    }
    Plotly.restyle(plotDiv, {'x':[axp],'y':[ayp]}, [arrowLinesIdx]);
    Plotly.restyle(plotDiv, {'x':[hxp],'y':[hyp]}, [arrowHeadsIdx]);

    timeSlider.value = idx;
    timeDisplay.textContent = data.t[idx].toFixed(2);
  }

  timeSlider.addEventListener('input', (e)=> updateFrame(parseInt(e.target.value)));
  speedRange.addEventListener('input', ()=> {
    const v = parseInt(speedRange.value);
    playSpeedMs = Math.max(10, Math.round(1100 - 2 * v));
  });

  playBtn.addEventListener('click', ()=>{
    if(!simData) return;
    if(playInterval){
      clearInterval(playInterval);
      playInterval = null;
      playBtn.textContent = '▶ Play';
      return;
    }
    playBtn.textContent = 'Pause';
    const maxIdx = simData.t.length - 1;
    playInterval = setInterval(()=>{
      let idx = parseInt(timeSlider.value);
      idx = (idx < maxIdx) ? idx + 1 : 0;
      updateFrame(idx);
    }, playSpeedMs);
  });

  runBtn.addEventListener('click', async ()=>{
    runBtn.disabled = true;
    progressBar.style.width = '2%';
    try {
      const n_image = parseInt(nImageInput.value) || 100;
      const grid_nx = parseInt(gridNxInput.value) || 100;
      const grid_ny = parseInt(gridNyInput.value) || 100;
      const Tfinal = parseFloat(TfinalInput.value) || 100.0;
      const compute_field = computeFieldCheckbox.checked ? 'True' : 'False';

      await ensurePyodide();
      await fetchAndInjectSimulation();

      statusEl.textContent = 'Calcul en cours (Python) — ceci peut prendre du temps...';
      const data = await callSim(n_image, grid_nx, grid_ny, Tfinal, compute_field);
      statusEl.textContent = 'Simulation calculée — rendu...';
      initPlot(data);
      updateFrame(0);
      statusEl.textContent = 'Terminé';
      progressBar.style.width = '100%';
    } catch(e){
      console.error(e);
      statusEl.textContent = 'Erreur : ' + (e.message || e);
      progressBar.style.width = '0%';
    } finally {
      runBtn.disabled = false;
    }
  });
</script>
</body>
</html>
